name: Deploy FAIT Coop Enhanced Site

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: fait-444705
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          export_default_credentials: true

      - name: Authenticate Docker to Google Artifact Registry
        run: |
          gcloud auth configure-docker

      # Remove any geargrab, tools, or scrapers components
      - name: Clean up repository
        run: |
          rm -rf geargrab tools scrapers
          echo "Removed geargrab, tools, and scrapers components"

      - name: Build and push Docker image
        run: |
          # Determine environment based on branch
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            BUILD_ENV=production
            IMAGE_TAG=prod-${{ github.sha }}
          elif [[ "${{ github.ref }}" == "refs/heads/staging" ]]; then
            BUILD_ENV=staging
            IMAGE_TAG=staging-${{ github.sha }}
          else
            BUILD_ENV=development
            IMAGE_TAG=dev-${{ github.sha }}
          fi

          # Build and push the Docker image with the appropriate environment
          docker build --build-arg BUILD_ENV=$BUILD_ENV -t gcr.io/fait-444705/fait-coop-enhanced:$IMAGE_TAG -t gcr.io/fait-444705/fait-coop-enhanced:latest .
          docker push gcr.io/fait-444705/fait-coop-enhanced:$IMAGE_TAG
          docker push gcr.io/fait-444705/fait-coop-enhanced:latest

      - name: Deploy to Cloud Run
        run: |
          # Determine environment and service name based on branch
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            BUILD_ENV=production
            IMAGE_TAG=prod-${{ github.sha }}
            SERVICE_NAME=fait-coop-enhanced
            MIN_INSTANCES=1
          elif [[ "${{ github.ref }}" == "refs/heads/staging" ]]; then
            BUILD_ENV=staging
            IMAGE_TAG=staging-${{ github.sha }}
            SERVICE_NAME=fait-coop-staging
            MIN_INSTANCES=0
          else
            BUILD_ENV=development
            IMAGE_TAG=dev-${{ github.sha }}
            SERVICE_NAME=fait-coop-dev
            MIN_INSTANCES=0
          fi

          # Deploy to Cloud Run
          gcloud run deploy $SERVICE_NAME \
            --image gcr.io/fait-444705/fait-coop-enhanced:$IMAGE_TAG \
            --platform managed \
            --region us-central1 \
            --allow-unauthenticated \
            --memory=512Mi \
            --cpu=1 \
            --min-instances=$MIN_INSTANCES \
            --max-instances=10 \
            --concurrency=80 \
            --timeout=300s \
            --set-env-vars="NODE_ENV=$BUILD_ENV" \
            --project fait-444705

      # Update Firebase Hosting to point to the new Cloud Run service
      - name: Set up Firebase CLI
        run: npm install -g firebase-tools

      - name: Update Firebase Configuration
        run: |
          # Determine service name based on branch
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            SERVICE_NAME=fait-coop-enhanced
            TARGET=fait-coop-react
          elif [[ "${{ github.ref }}" == "refs/heads/staging" ]]; then
            SERVICE_NAME=fait-coop-staging
            TARGET=fait-coop-staging
          else
            SERVICE_NAME=fait-coop-dev
            TARGET=fait-coop-dev
          fi

          # Update firebase.json to point to the correct service
          jq --arg service "$SERVICE_NAME" '.hosting[0].rewrites[0].run.serviceId = $service' firebase.json > firebase.json.tmp
          mv firebase.json.tmp firebase.json

          # Deploy to Firebase Hosting
          firebase use fait-444705
          firebase deploy --only hosting:$TARGET
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
