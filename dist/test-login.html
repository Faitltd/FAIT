<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
    }
    h1 {
      color: #333;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }
    .test-section {
      margin-bottom: 30px;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    .test-section h2 {
      margin-top: 0;
    }
    .test-credentials {
      background-color: #f5f5f5;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    .test-credentials div {
      margin-bottom: 5px;
    }
    button {
      background-color: #4CAF50;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-right: 10px;
    }
    button:hover {
      background-color: #45a049;
    }
    .results {
      margin-top: 20px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      background-color: #f9f9f9;
      min-height: 100px;
    }
    .success {
      color: green;
      font-weight: bold;
    }
    .failure {
      color: red;
      font-weight: bold;
    }
    .loading {
      color: blue;
      font-style: italic;
    }
  </style>
</head>
<body>
  <h1>Login Functionality Test</h1>
  
  <div class="test-section">
    <h2>Test Credentials</h2>
    <div class="test-credentials">
      <div><strong>Admin:</strong> admin@itsfait.com / admin123</div>
      <div><strong>Client:</strong> client@itsfait.com / client123</div>
      <div><strong>Service Agent:</strong> service@itsfait.com / service123</div>
    </div>
    
    <h2>Run Tests</h2>
    <button onclick="testLogin('admin@itsfait.com', 'admin123', 'Admin', '/dashboard/admin')">Test Admin Login</button>
    <button onclick="testLogin('client@itsfait.com', 'client123', 'Client', '/dashboard/client')">Test Client Login</button>
    <button onclick="testLogin('service@itsfait.com', 'service123', 'Service Agent', '/dashboard/service-agent')">Test Service Agent Login</button>
    <button onclick="runAllTests()">Run All Tests</button>
    
    <h2>Results</h2>
    <div id="results" class="results">
      <p>Test results will appear here...</p>
    </div>
  </div>
  
  <script>
    // Test credentials
    const TEST_CREDENTIALS = [
      { email: 'admin@itsfait.com', password: 'admin123', type: 'Admin', dashboardPath: '/dashboard/admin' },
      { email: 'client@itsfait.com', password: 'client123', type: 'Client', dashboardPath: '/dashboard/client' },
      { email: 'service@itsfait.com', password: 'service123', type: 'Service Agent', dashboardPath: '/dashboard/service-agent' }
    ];
    
    // Results display element
    const resultsElement = document.getElementById('results');
    
    // Add a log message to the results
    function log(message, className = '') {
      const p = document.createElement('p');
      p.textContent = message;
      if (className) {
        p.className = className;
      }
      resultsElement.appendChild(p);
      console.log(message);
    }
    
    // Clear the results
    function clearResults() {
      resultsElement.innerHTML = '';
    }
    
    // Test login function
    async function testLogin(email, password, type, dashboardPath) {
      clearResults();
      log(`Testing ${type} login: ${email} / ${password}`, 'loading');
      
      try {
        // Open login page in a new tab
        const loginWindow = window.open('/login', '_blank');
        
        // Wait for page to load
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        // Check if window was blocked
        if (!loginWindow || loginWindow.closed) {
          log('Error: Popup window was blocked. Please allow popups for this site.', 'failure');
          return false;
        }
        
        // Execute script in the login window
        loginWindow.postMessage({
          action: 'login',
          email,
          password
        }, '*');
        
        // Listen for messages from the login window
        window.addEventListener('message', function(event) {
          if (event.data.action === 'loginResult') {
            const { success, currentPath } = event.data;
            
            if (success) {
              log(`Login successful! Redirected to: ${currentPath}`, 'success');
              
              if (currentPath.includes(dashboardPath)) {
                log(`✅ PASS: Redirected to correct dashboard: ${dashboardPath}`, 'success');
              } else {
                log(`❌ FAIL: Redirected to incorrect path: ${currentPath}. Expected: ${dashboardPath}`, 'failure');
              }
            } else {
              log(`❌ FAIL: Login failed. Current path: ${currentPath}`, 'failure');
            }
          }
        });
        
        // Inject script into login window
        loginWindow.eval(`
          // Wait for page to fully load
          setTimeout(() => {
            try {
              // Fill in login form
              const emailInput = document.querySelector('input[type="email"]');
              const passwordInput = document.querySelector('input[type="password"]');
              const submitButton = document.querySelector('button[type="submit"]');
              
              if (!emailInput || !passwordInput || !submitButton) {
                window.opener.postMessage({
                  action: 'loginResult',
                  success: false,
                  currentPath: window.location.pathname,
                  error: 'Login form elements not found'
                }, '*');
                return;
              }
              
              // Fill inputs
              emailInput.value = "${email}";
              passwordInput.value = "${password}";
              
              // Dispatch input events
              emailInput.dispatchEvent(new Event('input', { bubbles: true }));
              passwordInput.dispatchEvent(new Event('input', { bubbles: true }));
              
              // Submit form
              submitButton.click();
              
              // Check result after a delay
              setTimeout(() => {
                const currentPath = window.location.pathname;
                const success = currentPath.includes("${dashboardPath}");
                
                window.opener.postMessage({
                  action: 'loginResult',
                  success,
                  currentPath
                }, '*');
              }, 5000);
            } catch (error) {
              window.opener.postMessage({
                action: 'loginResult',
                success: false,
                currentPath: window.location.pathname,
                error: error.toString()
              }, '*');
            }
          }, 1000);
        `);
        
        return true;
      } catch (error) {
        log(`Error testing ${type} login: ${error}`, 'failure');
        return false;
      }
    }
    
    // Run all tests
    async function runAllTests() {
      clearResults();
      log('Running all login tests...', 'loading');
      
      for (const cred of TEST_CREDENTIALS) {
        await testLogin(cred.email, cred.password, cred.type, cred.dashboardPath);
        // Wait between tests
        await new Promise(resolve => setTimeout(resolve, 10000));
      }
      
      log('All tests completed!');
    }
  </script>
</body>
</html>
