options:
  logging: CLOUD_LOGGING_ONLY

steps:
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/$REPO_NAME:$COMMIT_SHA', '-f', 'Dockerfile', '.']
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/$REPO_NAME:$COMMIT_SHA']
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args:
      - run
      - deploy
      - fait-coop
      - --image=gcr.io/$PROJECT_ID/$REPO_NAME:$COMMIT_SHA
      - --region=us-central1
      - --platform=managed
      - --allow-unauthenticated
      - --set-env-vars=SUPABASE_URL=${_SUPABASE_URL},SUPABASE_ANON_KEY=${_SUPABASE_ANON_KEY},SUPABASE_SERVICE_KEY=${_SUPABASE_SERVICE_KEY},SUPABASE_SERVICE_ROLE_KEY=${_SUPABASE_SERVICE_ROLE_KEY},JWT_SECRET=${_JWT_SECRET},VITE_GOOGLE_CLIENT_ID=${_VITE_GOOGLE_CLIENT_ID},VITE_STRIPE_PUBLIC_KEY=${_VITE_STRIPE_PUBLIC_KEY}

substitutions:
  _SUPABASE_URL: ""
  _SUPABASE_ANON_KEY: ""
  _SUPABASE_SERVICE_KEY: ""
  _SUPABASE_SERVICE_ROLE_KEY: ""
  _JWT_SECRET: ""
  _VITE_GOOGLE_CLIENT_ID: ""
  _VITE_STRIPE_PUBLIC_KEY: ""

images:
  - gcr.io/$PROJECT_ID/$REPO_NAME:$COMMIT_SHA
