<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAIT Auth Diagnostic</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f0f0f0;
      color: #333;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1, h2 {
      color: #2c3e50;
    }
    .status {
      padding: 15px;
      background-color: #e7f7e7;
      border-left: 5px solid #28a745;
      margin-bottom: 20px;
    }
    .error {
      padding: 15px;
      background-color: #f8d7da;
      border-left: 5px solid #dc3545;
      margin-bottom: 20px;
    }
    .warning {
      padding: 15px;
      background-color: #fff3cd;
      border-left: 5px solid #ffc107;
      margin-bottom: 20px;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    button:hover {
      background-color: #45a049;
    }
    input {
      padding: 10px;
      margin-bottom: 10px;
      width: 100%;
      box-sizing: border-box;
    }
    .test-account {
      background-color: #f8f9fa;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
    }
    .log {
      background-color: #f8f9fa;
      padding: 10px;
      margin-top: 20px;
      border-radius: 4px;
      max-height: 200px;
      overflow-y: auto;
      font-family: monospace;
      white-space: pre-wrap;
    }
    .tab {
      overflow: hidden;
      border: 1px solid #ccc;
      background-color: #f1f1f1;
      border-radius: 4px 4px 0 0;
    }
    .tab button {
      background-color: inherit;
      float: left;
      border: none;
      outline: none;
      cursor: pointer;
      padding: 14px 16px;
      transition: 0.3s;
      color: #333;
    }
    .tab button:hover {
      background-color: #ddd;
    }
    .tab button.active {
      background-color: #4CAF50;
      color: white;
    }
    .tabcontent {
      display: none;
      padding: 20px;
      border: 1px solid #ccc;
      border-top: none;
      border-radius: 0 0 4px 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>FAIT Authentication Diagnostic</h1>

    <div id="status" class="status">
      <p>This tool will help diagnose authentication issues with the FAIT platform.</p>
    </div>

    <div class="tab">
      <button class="tablinks active" onclick="openTab(event, 'AuthMode')">Auth Mode</button>
      <button class="tablinks" onclick="openTab(event, 'SupabaseTest')">Supabase Test</button>
      <button class="tablinks" onclick="openTab(event, 'LocalTest')">Local Auth Test</button>
      <button class="tablinks" onclick="openTab(event, 'ClearData')">Clear Data</button>
    </div>

    <div id="AuthMode" class="tabcontent" style="display: block;">
      <h2>Authentication Mode</h2>
      <p>Current authentication mode: <span id="current-mode">Checking...</span></p>
      <button id="enable-local-btn">Enable Local Auth</button>
      <button id="disable-local-btn">Use Supabase Auth</button>
    </div>

    <div id="SupabaseTest" class="tabcontent">
      <h2>Test Supabase Authentication</h2>
      <div id="supabase-status" class="status">
        <p>Enter credentials to test Supabase authentication.</p>
      </div>
      <input type="email" id="supabase-email" placeholder="Email" value="admin@itsfait.com">
      <input type="password" id="supabase-password" placeholder="Password" value="admin123">
      <button id="supabase-test-btn">Test Supabase Login</button>
      <div id="supabase-result"></div>
    </div>

    <div id="LocalTest" class="tabcontent">
      <h2>Test Local Authentication</h2>
      <div id="local-status" class="status">
        <p>Enter credentials to test local authentication.</p>
      </div>
      <input type="email" id="local-email" placeholder="Email" value="admin@itsfait.com">
      <input type="password" id="local-password" placeholder="Password" value="admin123">
      <button id="local-test-btn">Test Local Login</button>
      <div id="local-result"></div>
    </div>

    <div id="ClearData" class="tabcontent">
      <h2>Clear Authentication Data</h2>
      <p>Use these options to clear authentication data and start fresh.</p>
      <button id="clear-all-btn">Clear All Auth Data</button>
      <button id="clear-supabase-btn">Clear Supabase Data</button>
      <button id="clear-local-btn">Clear Local Auth Data</button>
      <div id="clear-result"></div>
    </div>

    <div class="log" id="log"></div>
  </div>

  <script>
    // Logging function
    function log(message) {
      const logElement = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      logElement.innerHTML += `[${timestamp}] ${message}\n`;
      logElement.scrollTop = logElement.scrollHeight;
    }

    // Tab functionality
    function openTab(evt, tabName) {
      var i, tabcontent, tablinks;
      tabcontent = document.getElementsByClassName("tabcontent");
      for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
      }
      tablinks = document.getElementsByClassName("tablinks");
      for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
      }
      document.getElementById(tabName).style.display = "block";
      evt.currentTarget.className += " active";
    }

    // Check if localStorage is available
    function isLocalStorageAvailable() {
      try {
        localStorage.setItem('test', 'test');
        localStorage.removeItem('test');
        return true;
      } catch (e) {
        log('Error: LocalStorage is not available');
        return false;
      }
    }

    // Check current auth mode
    function checkAuthMode() {
      if (!isLocalStorageAvailable()) {
        document.getElementById('status').innerHTML =
          '<p><strong>Error:</strong> LocalStorage is not available. Authentication will not work.</p>';
        document.getElementById('status').className = 'error';
        return;
      }

      const useLocalAuth = localStorage.getItem('useLocalAuth');
      const authMode = useLocalAuth === 'true' ? 'Local Authentication' : 'Supabase Authentication';

      document.getElementById('current-mode').textContent = authMode;
      log(`Current auth mode: ${authMode}`);
    }

    // Enable local auth
    function enableLocalAuth() {
      if (!isLocalStorageAvailable()) return;

      localStorage.setItem('useLocalAuth', 'true');
      log('Local authentication enabled');
      checkAuthMode();
    }

    // Disable local auth
    function disableLocalAuth() {
      if (!isLocalStorageAvailable()) return;

      localStorage.setItem('useLocalAuth', 'false');
      log('Supabase authentication enabled');
      checkAuthMode();
    }

    // Clear all auth data
    function clearAllAuthData() {
      if (!isLocalStorageAvailable()) return;

      // Clear all auth-related items
      const keysToRemove = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && (
          key.includes('supabase') ||
          key.includes('auth') ||
          key.includes('sb-') ||
          key === 'useLocalAuth' ||
          key === 'localAuth' ||
          key === 'localAuthSession'
        )) {
          keysToRemove.push(key);
        }
      }

      keysToRemove.forEach(key => localStorage.removeItem(key));

      log(`Cleared ${keysToRemove.length} auth-related items from localStorage`);
      document.getElementById('clear-result').innerHTML =
        `<p>Cleared ${keysToRemove.length} auth-related items from localStorage</p>`;
    }

    // Clear Supabase auth data
    function clearSupabaseAuthData() {
      if (!isLocalStorageAvailable()) return;

      // Clear Supabase auth-related items
      const keysToRemove = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && (
          key.includes('supabase') ||
          key.includes('sb-')
        )) {
          keysToRemove.push(key);
        }
      }

      keysToRemove.forEach(key => localStorage.removeItem(key));

      log(`Cleared ${keysToRemove.length} Supabase auth items from localStorage`);
      document.getElementById('clear-result').innerHTML =
        `<p>Cleared ${keysToRemove.length} Supabase auth items from localStorage</p>`;
    }

    // Clear local auth data
    function clearLocalAuthData() {
      if (!isLocalStorageAvailable()) return;

      // Clear local auth-related items
      const keysToRemove = ['localAuth', 'localAuthSession'];
      keysToRemove.forEach(key => localStorage.removeItem(key));

      log(`Cleared local auth data from localStorage`);
      document.getElementById('clear-result').innerHTML =
        `<p>Cleared local auth data from localStorage</p>`;
    }

    // Test Supabase authentication
    async function testSupabaseAuth() {
      const email = document.getElementById('supabase-email').value;
      const password = document.getElementById('supabase-password').value;

      if (!email || !password) {
        document.getElementById('supabase-status').innerHTML =
          '<p><strong>Error:</strong> Please enter both email and password.</p>';
        document.getElementById('supabase-status').className = 'error';
        return;
      }

      log(`Testing Supabase login with email: ${email}`);
      document.getElementById('supabase-result').innerHTML = '<p>Testing...</p>';

      try {
        // Get Supabase URL and key from localStorage if available
        let supabaseUrl = localStorage.getItem('supabaseUrl') || 'https://sjrehyseqqptdcnadvod.supabase.co';
        let supabaseAnonKey = localStorage.getItem('supabaseAnonKey') || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqcmVoeXNlcXFwdGRjbmFkdm9kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM0MzMxMzcsImV4cCI6MjA1OTAwOTEzN30.fPyawZcgteRLZUH0MvtVSmNmZSdbxUOyN9lo6BDe8-8';

        log(`Using Supabase URL: ${supabaseUrl}`);

        // Create Supabase client
        const supabase = supabase.createClient(supabaseUrl, supabaseAnonKey);

        // Sign in
        const { data, error } = await supabase.auth.signInWithPassword({
          email,
          password
        });

        if (error) {
          log(`Supabase login error: ${error.message}`);
          document.getElementById('supabase-status').innerHTML =
            `<p><strong>Error:</strong> ${error.message}</p>`;
          document.getElementById('supabase-status').className = 'error';
          document.getElementById('supabase-result').innerHTML = '';
        } else {
          log(`Supabase login successful for user: ${data.user.email}`);
          document.getElementById('supabase-status').innerHTML =
            '<p><strong>Success:</strong> Login successful!</p>';
          document.getElementById('supabase-status').className = 'status';
          document.getElementById('supabase-result').innerHTML =
            `<p>User ID: ${data.user.id}</p>
             <p>Email: ${data.user.email}</p>`;

          // Sign out
          await supabase.auth.signOut();
          log('Signed out of Supabase');
        }
      } catch (err) {
        log(`Error testing Supabase auth: ${err.message}`);
        document.getElementById('supabase-status').innerHTML =
          `<p><strong>Error:</strong> ${err.message}</p>`;
        document.getElementById('supabase-status').className = 'error';
        document.getElementById('supabase-result').innerHTML = '';
      }
    }

    // Test local authentication
    function testLocalAuth() {
      const email = document.getElementById('local-email').value;
      const password = document.getElementById('local-password').value;

      if (!email || !password) {
        document.getElementById('local-status').innerHTML =
          '<p><strong>Error:</strong> Please enter both email and password.</p>';
        document.getElementById('local-status').className = 'error';
        return;
      }

      log(`Testing local login with email: ${email}`);
      document.getElementById('local-result').innerHTML = '<p>Testing...</p>';

      // Test credentials
      const validCredentials = {
        'admin@itsfait.com': 'admin123',
        'client@itsfait.com': 'client123',
        'service@itsfait.com': 'service123'
      };

      if (validCredentials[email] === password) {
        log(`Local login successful for user: ${email}`);
        document.getElementById('local-status').innerHTML =
          '<p><strong>Success:</strong> Login successful!</p>';
        document.getElementById('local-status').className = 'status';

        // Determine user type
        let userType = 'client';
        if (email === 'admin@itsfait.com') userType = 'admin';
        if (email === 'service@itsfait.com') userType = 'service_agent';

        document.getElementById('local-result').innerHTML =
          `<p>Email: ${email}</p>
           <p>User Type: ${userType}</p>`;
      } else {
        log(`Local login failed for user: ${email}`);
        document.getElementById('local-status').innerHTML =
          '<p><strong>Error:</strong> Invalid email or password.</p>';
        document.getElementById('local-status').className = 'error';
        document.getElementById('local-result').innerHTML = '';
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      log('Auth diagnostic tool initialized');
      checkAuthMode();

      // Add event listeners
      document.getElementById('enable-local-btn').addEventListener('click', enableLocalAuth);
      document.getElementById('disable-local-btn').addEventListener('click', disableLocalAuth);
      document.getElementById('clear-all-btn').addEventListener('click', clearAllAuthData);
      document.getElementById('clear-supabase-btn').addEventListener('click', clearSupabaseAuthData);
      document.getElementById('clear-local-btn').addEventListener('click', clearLocalAuthData);
      document.getElementById('supabase-test-btn').addEventListener('click', testSupabaseAuth);
      document.getElementById('local-test-btn').addEventListener('click', testLocalAuth);
    });
  </script>
</body>
</html>
