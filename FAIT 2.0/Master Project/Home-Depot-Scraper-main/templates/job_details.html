{% extends "base.html" %}

{% block title %}Home Depot Scraper - Job {{ job.job_id }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12 mb-4">
        <a href="/jobs" class="btn download-btn" style="width: auto !important; display: inline-block !important;">&laquo; BACK TO JOBS</a>
    </div>

    <div class="col-md-12">
        <div class="card pixel-border mb-4">
            <div class="card-header bg-primary">
                <div class="d-flex align-items-center">
                    <div class="hd-logo me-3" style="width: 40px; height: 40px;"></div>
                    <h2 class="mb-0 jobs-title">Job #{{ job.job_id }} Details</h2>
                </div>
            </div>

            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h4>Status</h4>
                        <p>
                            {% if job.status == 'pending' %}
                            <span class="badge bg-secondary">Pending</span>
                            {% elif job.status == 'running' %}
                            <span class="badge bg-primary">Running</span>
                            {% elif job.status == 'completed' %}
                            <span class="badge bg-success">Completed</span>
                            {% elif job.status == 'failed' %}
                            <span class="badge bg-danger">Failed</span>
                            {% elif job.status == 'cancelled' %}
                            <span class="badge bg-warning">Cancelled</span>
                            {% endif %}
                        </p>

                        <h4>Progress</h4>
                        {% if job.status == 'running' %}
                        <!-- Live Status Display -->
                        <div id="live-status" class="card mb-2">
                            <div class="card-body p-2 bg-light">
                                <h6 class="card-subtitle mb-1 text-muted">Current Activity:</h6>
                                <div id="status-line-1" class="status-line">Initializing...</div>
                                <div id="status-line-2" class="status-line">Please wait...</div>
                            </div>
                        </div>

                        <!-- Detailed Live Log Window -->
                        <div id="detailed-live-log" class="card mb-2">
                            <div class="card-header p-2 bg-dark text-white d-flex justify-content-between align-items-center">
                                <h6 class="card-subtitle mb-0">Detailed Process Log:</h6>
                                <span class="badge bg-success blink">LIVE</span>
                            </div>
                            <div class="card-body p-2" style="max-height: 300px; overflow-y: auto; background-color: #000; color: #0f0; font-family: monospace; font-size: 0.8rem; border: 2px solid #fd67a3;">
                                <div id="detailed-log-content"></div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Search/Category Progress -->
                        <h6 class="mt-3 mb-2">Search/Category Progress:</h6>
                        <div class="progress mb-2">
                            <div class="progress-bar" role="progressbar" style="width: {{ job.progress.percentage }}%;"
                                 aria-valuenow="{{ job.progress.percentage }}" aria-valuemin="0" aria-valuemax="100">
                                {{ job.progress.percentage }}%
                            </div>
                        </div>
                        <p>{{ job.progress.current }} of {{ job.progress.total }} items processed</p>

                        <!-- Product Scraping Progress -->
                        <h6 class="mt-3 mb-2">Product Scraping Progress:</h6>
                        <div class="progress mb-2">
                            <div id="product-progress-bar" class="progress-bar bg-success" role="progressbar" style="width: {{ job.product_progress.percentage if job.product_progress else 0 }}%;"
                                 aria-valuenow="{{ job.product_progress.percentage if job.product_progress else 0 }}" aria-valuemin="0" aria-valuemax="100">
                                {{ job.product_progress.percentage if job.product_progress else 0 }}%
                            </div>
                        </div>
                        <p id="product-progress-text">{{ job.product_progress.current if job.product_progress else 0 }} of {{ job.product_progress.total if job.product_progress else 0 }} products scraped</p>

                        <h4>Timing</h4>
                        <p><strong>Start Time:</strong> {{ job.start_time }}</p>
                        {% if job.end_time %}
                        <p><strong>End Time:</strong> {{ job.end_time }}</p>
                        {% endif %}
                    </div>

                    <div class="col-md-6">
                        <h4>Settings</h4>
                        <table class="table table-sm">
                            <tbody>
                                <tr>
                                    <th>Search Type</th>
                                    <td>{{ job.config.search_type }}</td>
                                </tr>
                                {% if job.config.search_type == 'category' %}
                                <tr>
                                    <th>Category ID</th>
                                    <td>{{ job.config.category_id }}</td>
                                </tr>
                                {% elif job.config.search_type == 'search_term' %}
                                <tr>
                                    <th>Search Terms</th>
                                    <td>
                                        <ul class="mb-0">
                                            {% for term in job.config.search_terms %}
                                            <li>{{ term }}</li>
                                            {% endfor %}
                                        </ul>
                                    </td>
                                </tr>
                                <tr>
                                    <th>Sort By</th>
                                    <td>{{ job.config.sort_by }}</td>
                                </tr>
                                {% elif job.config.search_type == 'url_list' %}
                                <tr>
                                    <th>URLs</th>
                                    <td>
                                        <div style="max-height: 200px; overflow-y: auto;">
                                            <ul class="mb-0">
                                                {% for url in job.config.urls %}
                                                <li>{{ url }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                                {% endif %}
                                <tr>
                                    <th>Max Pages</th>
                                    <td>{{ job.config.max_pages }}</td>
                                </tr>
                                <tr>
                                    <th>Max Products</th>
                                    <td>{{ job.config.max_products }}</td>
                                </tr>
                                <tr>
                                    <th>Output Directory</th>
                                    <td>{{ job.config.output_dir }}</td>
                                </tr>
                                {% if job.config.job_dir %}
                                <tr>
                                    <th>Job Directory</th>
                                    <td>{{ job.config.job_dir }}</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>

                        {% if job.config.csv_headers %}
                        <h4>Custom CSV Headers</h4>
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Original Header</th>
                                    <th>Custom Header</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for key, value in job.config.csv_headers.items() %}
                                <tr>
                                    <td>{{ key }}</td>
                                    <td>{{ value }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% endif %}
                    </div>
                </div>

                {% if job.error %}
                <div class="alert alert-danger mt-3">
                    <h4>Error</h4>
                    <p>{{ job.error }}</p>
                </div>
                {% endif %}

                {% if job.result_files %}
                <div class="mt-4">
                    <h4 style="font-family: 'Press Start 2P', cursive; color: #f96302; text-shadow: 1px 1px 0 #000;">Result Files</h4>

                    <ul class="list-group pixel-border" style="border: 4px solid #000;">
                        {% for file in job.result_files %}
                        <li class="list-group-item text-center" style="border-bottom: 4px solid #000;">
                            <div class="mb-3" style="font-family: 'Press Start 2P', cursive; font-size: 0.8rem;">{{ file }}</div>
                            <a href="/api/download/{{ job.job_id }}/{{ file }}" class="btn download-btn">DOWNLOAD</a>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                {% if job.status == 'running' %}
                <div class="mt-4 text-center">
                    <button id="end-now" class="btn download-btn me-3" style="width: 30% !important; display: inline-block !important;">END NOW</button>
                    <button id="stop-scraping" class="btn download-btn me-3" style="width: 30% !important; display: inline-block !important;">STOP & SAVE</button>
                    <button id="cancel-job" class="btn download-btn" style="width: 30% !important; display: inline-block !important; background-color: #ff3300 !important;">CANCEL JOB</button>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="card pixel-border">
            <div class="card-header bg-primary">
                <div class="d-flex align-items-center">
                    <div class="hd-logo me-3" style="width: 30px; height: 30px;"></div>
                    <h3 class="mb-0 jobs-title">Log Messages</h3>
                </div>
            </div>
            <div class="card-body">
                <div id="log-container" style="max-height: 400px; overflow-y: auto; background-color: #000; color: #0f0; padding: 15px; border: 4px solid #f96302; font-family: 'Press Start 2P', cursive; font-size: 0.7rem;">
                    {% for message in log_messages %}
                        {% if not 'API key' in message and not 'password' in message and not 'secret' in message and not 'token' in message %}
                            <div class="log-message">{{ message }}</div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        const jobId = {{ job.job_id }};
        const isRunning = {{ 'true' if job.status == 'running' else 'false' }};

        // Auto-refresh for running jobs
        if (isRunning) {
            // Refresh job data every 2 seconds
            setInterval(function() {
                $.ajax({
                    url: '/api/job/' + jobId,
                    type: 'GET',
                    success: function(data) {
                        // If status changed, reload the page
                        if (data.job.status !== 'running') {
                            location.reload();
                            return;
                        }

                        // Update main progress bar
                        const percentage = data.job.progress.percentage;
                        $('.progress-bar').first().css('width', percentage + '%').attr('aria-valuenow', percentage).text(percentage + '%');

                        // Update progress text
                        $('p:contains("items processed")').text(data.job.progress.current + ' of ' + data.job.progress.total + ' items processed');

                        // Update product progress bar if available
                        if (data.job.product_progress) {
                            const productPercentage = data.job.product_progress.percentage;
                            $('#product-progress-bar').css('width', productPercentage + '%')
                                .attr('aria-valuenow', productPercentage)
                                .text(productPercentage + '%');
                            $('#product-progress-text').text(
                                data.job.product_progress.current + ' of ' +
                                data.job.product_progress.total + ' products scraped'
                            );
                        }

                        // Update log messages
                        const logContainer = $('#log-container');
                        logContainer.empty();

                        // Process all log messages, filtering out sensitive information
                        data.log_messages.forEach(function(message) {
                            // Skip messages containing sensitive information
                            if (!message.includes('API key') &&
                                !message.includes('password') &&
                                !message.includes('secret') &&
                                !message.includes('token')) {
                                logContainer.append('<div class="log-message">' + message + '</div>');
                            }
                        });

                        // Extract the last two meaningful log lines for the status display
                        if (data.log_messages.length > 0) {
                            // Filter out messages that are just timestamps or not informative
                            const meaningfulLogs = data.log_messages.filter(function(msg) {
                                // Look for messages that contain useful information
                                return (
                                    msg.includes('product URL') ||
                                    msg.includes('search term') ||
                                    msg.includes('category') ||
                                    msg.includes('Scraping') ||
                                    msg.includes('scraping') ||
                                    msg.includes('Processing') ||
                                    msg.includes('processing') ||
                                    msg.includes('Fetching') ||
                                    msg.includes('fetching') ||
                                    msg.includes('Saving') ||
                                    msg.includes('saving') ||
                                    msg.includes('Found') ||
                                    msg.includes('found') ||
                                    msg.includes('Successfully') ||
                                    msg.includes('successfully') ||
                                    msg.includes('product data') ||
                                    msg.includes('Product data')
                                );
                            });

                            // Get the last two meaningful messages
                            if (meaningfulLogs.length > 0) {
                                const lastMsg = meaningfulLogs[meaningfulLogs.length - 1];
                                $('#status-line-2').text(lastMsg.substring(lastMsg.indexOf(']') + 2));

                                if (meaningfulLogs.length > 1) {
                                    const secondLastMsg = meaningfulLogs[meaningfulLogs.length - 2];
                                    $('#status-line-1').text(secondLastMsg.substring(secondLastMsg.indexOf(']') + 2));
                                }
                            }
                        }

                        // Update the detailed live log window with scraper-specific messages
                        const detailedLogContent = $('#detailed-log-content');

                        // Filter for detailed scraper logs - be more inclusive to catch all relevant logs
                        const detailedLogs = data.log_messages.filter(function(msg) {
                            // Always show detailed logs during scraping, not just during search
                            return (
                                // Include all scraper logs
                                msg.includes('scraper') ||
                                // Include all API responses and product data
                                msg.includes('product data') ||
                                msg.includes('product URL') ||
                                msg.includes('field') ||
                                msg.includes('SKU') ||
                                msg.includes('description') ||
                                msg.includes('price') ||
                                msg.includes('scraped product') ||
                                msg.includes('products scraped') ||
                                msg.includes('Fetching') ||
                                msg.includes('Processing') ||
                                msg.includes('Raw') ||
                                msg.includes('API') ||
                                msg.includes('URL') ||
                                // Additional scraping-specific logs
                                msg.includes('Scraping') ||
                                msg.includes('scraping') ||
                                msg.includes('Found') ||
                                msg.includes('Saved') ||
                                msg.includes('Extracted') ||
                                msg.includes('Response') ||
                                msg.includes('data') ||
                                msg.includes('keys') ||
                                msg.includes('image') ||
                                msg.includes('brand') ||
                                msg.includes('title') ||
                                msg.includes('specifications') ||
                                msg.includes('features')
                            );
                        });

                        // Always update the detailed log content
                        // Keep only the last 30 detailed logs to avoid performance issues
                        const recentDetailedLogs = detailedLogs.slice(-30);

                        // Clear and repopulate the detailed log content
                        detailedLogContent.empty();

                        if (recentDetailedLogs.length > 0) {
                            recentDetailedLogs.forEach(function(log) {
                                // Format the log message for better readability
                                let formattedLog = log;

                                // Highlight important parts with colors
                                if (log.includes('Successfully scraped product')) {
                                    formattedLog = '<span style="color: #00ff00;">' + log + '</span>';
                                } else if (log.includes('ERROR') || log.includes('Error') || log.includes('error')) {
                                    formattedLog = '<span style="color: #ff0000;">' + log + '</span>';
                                } else if (log.includes('WARNING') || log.includes('Warning') || log.includes('warning')) {
                                    formattedLog = '<span style="color: #ffff00;">' + log + '</span>';
                                } else if (log.includes('Found SKU') || log.includes('Found price') || log.includes('Found description')) {
                                    formattedLog = '<span style="color: #00ffff;">' + log + '</span>';
                                } else if (log.includes('Fetching details') || log.includes('Processing product data')) {
                                    formattedLog = '<span style="color: #ff9d7d;">' + log + '</span>';
                                } else if (log.includes('Added product URL')) {
                                    formattedLog = '<span style="color: #fd67a3;">' + log + '</span>';
                                }

                                detailedLogContent.append('<div class="detailed-log-line">' + formattedLog + '</div>');
                            });
                        } else {
                            // If no detailed logs found, show a message
                            detailedLogContent.append('<div class="detailed-log-line">Waiting for scraper logs...</div>');
                        }

                        // Scroll to bottom of detailed log
                        const detailedLogContainer = detailedLogContent.parent();
                        detailedLogContainer.scrollTop(detailedLogContainer[0].scrollHeight);

                        // Scroll to bottom of log
                        logContainer.scrollTop(logContainer[0].scrollHeight);
                    }
                });
            }, 2000);

            // Scroll to bottom of log initially
            const logContainer = $('#log-container');
            logContainer.scrollTop(logContainer[0].scrollHeight);
        }

        // End Now button
        $('#end-now').click(function() {
            if (confirm('Are you sure you want to end the job now and save results? This will complete the job gracefully.')) {
                $.ajax({
                    url: '/api/end_job/' + jobId,
                    type: 'POST',
                    success: function(response) {
                        alert(response.message);
                        location.reload();
                    },
                    error: function(xhr, status, error) {
                        alert('Error ending job: ' + (xhr.responseJSON?.error || error));
                    }
                });
            }
        });

        // Stop Scraping & Save button
        $('#stop-scraping').click(function() {
            if (confirm('Are you sure you want to stop scraping and save what has been gathered so far?')) {
                $.ajax({
                    url: '/api/stop_scraping/' + jobId,
                    type: 'POST',
                    success: function(response) {
                        alert(response.message);
                        location.reload();
                    },
                    error: function(xhr, status, error) {
                        alert('Error stopping scraping: ' + (xhr.responseJSON?.error || error));
                    }
                });
            }
        });

        // Cancel job button
        $('#cancel-job').click(function() {
            if (confirm('Are you sure you want to cancel this job? This will NOT save any data.')) {
                $.ajax({
                    url: '/api/cancel_job/' + jobId,
                    type: 'POST',
                    success: function(response) {
                        alert(response.message);
                        location.reload();
                    },
                    error: function(xhr, status, error) {
                        alert('Error cancelling job: ' + (xhr.responseJSON?.error || error));
                    }
                });
            }
        });
    });
</script>
{% endblock %}
