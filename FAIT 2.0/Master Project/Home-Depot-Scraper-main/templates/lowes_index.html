{% extends "lowes_base.html" %}

{% block title %}Lowe's Scraper{% endblock %}

{% block content %}
<div class="new-job-page">
<div class="row">
    <div class="col-md-12">
        <div class="card pixel-border">
            <div class="card-header bg-primary text-white">
                <div class="d-flex align-items-center">
                    <div class="lowes-logo me-3" style="width: 40px; height: 40px;"></div>
                    <h2 class="mb-0" style="font-family: 'Press Start 2P', cursive; font-size: 1.2rem; text-shadow: 2px 2px 0 #000;">NEW SCRAPER JOB</h2>
                </div>
            </div>
            <div class="card-body">
                <form id="scraper-form">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="search-type">Search Type</label>
                                <select class="form-control" id="search-type" name="search_type">
                                    <option value="category">Category</option>
                                    <option value="search_term">Search Term</option>
                                    <option value="url_list">URL List</option>
                                </select>
                            </div>

                            <!-- Category options -->
                            <div id="category-options" class="search-options">
                                <div class="mb-3">
                                    <label for="category">Category</label>
                                    <select class="form-control" id="category" name="category">
                                        {% for category_name, category_id in categories.items() %}
                                            <option value="{{ category_id }}">{{ category_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <!-- Search term options -->
                            <div id="search-term-options" class="search-options">
                                <div class="mb-3">
                                    <label for="search-terms">Search Terms (one per line)</label>
                                    <textarea class="form-control" id="search-terms" name="search_terms" rows="5" placeholder="Enter search terms, one per line"></textarea>
                                </div>
                            </div>

                            <!-- URL list options -->
                            <div id="url-list-options" class="search-options">
                                <div class="mb-3">
                                    <label for="urls">Product URLs (one per line)</label>
                                    <textarea class="form-control" id="urls" name="urls" rows="5" placeholder="Enter Lowe's product URLs, one per line"></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="max-pages">Maximum Pages</label>
                                <select class="form-control" id="max-pages" name="max_pages">
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="5" selected>5</option>
                                    <option value="10">10</option>
                                    <option value="15">15</option>
                                    <option value="20">20</option>
                                    <option value="30">30</option>
                                    <option value="50">50</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="max-products">Maximum Products</label>
                                <select class="form-control" id="max-products" name="max_products">
                                    <option value="1">1</option>
                                    <option value="10">10</option>
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                    <option value="75">75</option>
                                    <option value="100">100</option>
                                    <option value="150">150</option>
                                    <option value="200">200</option>
                                    <option value="300">300</option>
                                    <option value="400">400</option>
                                    <option value="500">500</option>
                                    <option value="1000">1000</option>
                                    <option value="0">ALL</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="output-format">Output Format</label>
                                <select class="form-control" id="output-format" name="output_format">
                                    <option value="csv">CSV</option>
                                    <option value="json">JSON</option>
                                    <option value="template">CSV Template</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- CSV Headers Customization -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <button class="btn btn-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#csvHeadersCollapse" aria-expanded="false" aria-controls="csvHeadersCollapse">
                                Customize CSV Headers
                            </button>
                            <div class="collapse mt-3" id="csvHeadersCollapse">
                                <div class="alert alert-info">
                                    Customize the CSV headers for your output file. These will be used when downloading results.
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-dark">
                                        <thead>
                                            <tr>
                                                <th>Field</th>
                                                <th>Custom Header</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for field, header in default_csv_headers.items() %}
                                            <tr>
                                                <td>{{ field }}</td>
                                                <td>
                                                    <input type="text" class="form-control csv-header-input"
                                                           name="csv_header_{{ field }}"
                                                           value="{{ header }}"
                                                           data-field="{{ field }}">
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                <div class="d-flex justify-content-end">
                                    <button class="btn btn-secondary" type="button" id="reset-headers">Reset to Default</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12 text-center">
                            <button type="submit" class="btn btn-primary btn-lg">Start Scraping</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Store the default headers
        const defaultHeaders = {
            {% for field, header in default_csv_headers.items() %}
            "{{ field }}": "{{ header }}",
            {% endfor %}
        };

        // Show/hide search type options based on selection
        function updateSearchTypeOptions() {
            const searchType = $('#search-type').val();
            $('.search-options').hide();

            if (searchType === 'category') {
                $('#category-options').show();
            } else if (searchType === 'search_term') {
                $('#search-term-options').show();
            } else if (searchType === 'url_list') {
                $('#url-list-options').show();
                // Set default max products to 1 for URL search
                $('#max-products').val('1');
            }
        }

        // Initial update
        updateSearchTypeOptions();

        // Update on change
        $('#search-type').change(updateSearchTypeOptions);

        // Reset headers to default
        $('#reset-headers').click(function() {
            for (const [field, header] of Object.entries(defaultHeaders)) {
                $(`input[name="csv_header_${field}"]`).val(header);
            }
        });

        // Form submission
        $('#scraper-form').submit(function(e) {
            e.preventDefault();

            // Collect form data
            const searchType = $('#search-type').val();
            const maxPages = $('#max-pages').val();
            const maxProducts = $('#max-products').val();
            const outputFormat = $('#output-format').val();

            // Collect search parameters based on search type
            let searchParams = {};
            if (searchType === 'category') {
                searchParams.category = $('#category').val();
            } else if (searchType === 'search_term') {
                searchParams.search_terms = $('#search-terms').val().split('\n').filter(term => term.trim() !== '');
            } else if (searchType === 'url_list') {
                searchParams.urls = $('#urls').val().split('\n').filter(url => url.trim() !== '');
            }

            // Collect custom CSV headers
            const csvHeaders = {};
            $('.csv-header-input').each(function() {
                const field = $(this).data('field');
                const value = $(this).val();
                csvHeaders[field] = value;
            });

            // Create the request data
            const requestData = {
                search_type: searchType,
                max_pages: parseInt(maxPages),
                max_products: parseInt(maxProducts),
                output_format: outputFormat,
                csv_headers: csvHeaders,
                ...searchParams
            };

            // Submit the job
            $.ajax({
                url: '/lowes/api/start_job',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(requestData),
                success: function(response) {
                    if (response.success) {
                        // Redirect to job details page
                        window.location.href = `/lowes/job/${response.job_id}`;
                    } else {
                        alert(`Error: ${response.error}`);
                    }
                },
                error: function(xhr, status, error) {
                    alert(`Error: ${error}`);
                }
            });
        });
    });
</script>
{% endblock %}
