name: Deploy to Google Cloud Run

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - development

env:
  PROJECT_ID: fait-444705
  SERVICE_NAME: fait-svelte
  REGION: us-central1

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ env.PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          export_default_credentials: true
      
      - name: Authorize Docker push
        run: gcloud auth configure-docker
      
      - name: Set environment variables
        run: |
          if [[ "${{ github.event.inputs.environment }}" == "staging" ]]; then
            echo "BUILD_ENV=staging" >> $GITHUB_ENV
            echo "MIN_INSTANCES=0" >> $GITHUB_ENV
          elif [[ "${{ github.event.inputs.environment }}" == "development" ]]; then
            echo "BUILD_ENV=development" >> $GITHUB_ENV
            echo "MIN_INSTANCES=0" >> $GITHUB_ENV
          else
            echo "BUILD_ENV=production" >> $GITHUB_ENV
            echo "MIN_INSTANCES=1" >> $GITHUB_ENV
          fi
          
          # Set image tag based on commit SHA
          echo "IMAGE_TAG=${GITHUB_SHA::8}" >> $GITHUB_ENV
      
      - name: Build and push Docker image
        run: |
          docker build \
            --build-arg BUILD_ENV=${{ env.BUILD_ENV }} \
            -t gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ env.IMAGE_TAG }} \
            -t gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:latest \
            .
          
          docker push gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ env.IMAGE_TAG }}
          docker push gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:latest
      
      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ env.IMAGE_TAG }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --allow-unauthenticated \
            --memory=512Mi \
            --cpu=1 \
            --min-instances=${{ env.MIN_INSTANCES }} \
            --max-instances=10 \
            --concurrency=80 \
            --timeout=300s \
            --set-env-vars="NODE_ENV=production" \
            --project ${{ env.PROJECT_ID }}
      
      - name: Show deployed service URL
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} --platform managed --region ${{ env.REGION }} --format 'value(status.url)')
          echo "Service deployed to: $SERVICE_URL"
          
      - name: Create GitHub deployment
        uses: chrnorm/deployment-action@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          environment: ${{ github.event.inputs.environment || 'production' }}
          initial-status: success
          description: Deployed to Google Cloud Run
          
      - name: Create deployment comment
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const serviceUrl = process.env.SERVICE_URL;
            const environment = process.env.ENVIRONMENT || 'production';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸš€ Deployed to ${environment} environment: ${serviceUrl}`
            })
        env:
          SERVICE_URL: ${{ steps.deploy.outputs.url }}
          ENVIRONMENT: ${{ github.event.inputs.environment || 'production' }}
